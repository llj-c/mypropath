# 离线部署快速指南

## 方式一：一键部署（推荐）

在离线环境中，使用一键部署脚本自动完成代码拉取和镜像导入：

### Windows
```powershell
# 方式1: 提供仓库地址和镜像文件路径
.\scripts\deploy_offline.ps1 https://github.com/user/repo.git .\docker_images\images_20240101_120000.tar.gz

# 方式2: 只提供仓库地址，自动查找最新的镜像文件
.\scripts\deploy_offline.ps1 https://github.com/user/repo.git

# 方式3: 如果当前目录已经是仓库，只需提供镜像文件路径
.\scripts\deploy_offline.ps1 "" .\docker_images\images_20240101_120000.tar.gz
```

### Linux/Mac
```bash
chmod +x scripts/deploy_offline.sh

# 方式1: 提供仓库地址和镜像文件路径
./scripts/deploy_offline.sh https://github.com/user/repo.git ./docker_images/images_20240101_120000.tar.gz

# 方式2: 只提供仓库地址，自动查找最新的镜像文件
./scripts/deploy_offline.sh https://github.com/user/repo.git

# 方式3: 如果当前目录已经是仓库，只需提供镜像文件路径
./scripts/deploy_offline.sh "" ./docker_images/images_20240101_120000.tar.gz
```

**一键部署脚本会自动完成:**
1. ✅ 检查/拉取代码仓库
2. ✅ 自动查找镜像文件（或使用指定路径）
3. ✅ 导入 Docker 镜像

---

## 方式二：分步部署

### 一、在已构建的机器上导出镜像

### Windows
```powershell
.\scripts\export_images.ps1
```

### Linux/Mac
```bash
chmod +x scripts/export_images.sh
./scripts/export_images.sh
```

导出文件位置: `docker_images/images_YYYYMMDD_HHMMSS.tar.gz`

## 二、传输镜像文件到离线环境

将 `docker_images/images_*.tar.gz` 文件复制到离线环境。

## 三、在离线环境中导入镜像

### Windows
```powershell
.\scripts\import_images.ps1 .\docker_images\images_20240101_120000.tar.gz
```

### Linux/Mac
```bash
chmod +x scripts/import_images.sh
./scripts/import_images.sh ./docker_images/images_20240101_120000.tar.gz
```

## 四、检查镜像

```bash
docker images
```

应该看到:
- `mysql:8.0`
- `redis:7-alpine`
- `pyt-fastapi:latest` (或类似名称)

## 五、启动服务

```bash
# 使用离线配置启动
docker compose -f docker-compose.offline.yaml up -d
```

---

## 完整流程示例

### 在已构建的机器上（有网络）:
```bash
# 1. 拉取代码
git clone <仓库地址>
cd pyt

# 2. 构建镜像（如果需要）
docker compose build fastapi

# 3. 导出镜像
chmod +x scripts/export_images.sh
./scripts/export_images.sh
```

### 在离线环境中:
```bash
# 方式A: 一键部署（推荐）
chmod +x scripts/deploy_offline.sh
./scripts/deploy_offline.sh <仓库地址>

# 方式B: 分步部署
# 1. 拉取代码
git clone <仓库地址>
cd pyt

# 2. 导入镜像
chmod +x scripts/import_images.sh
./scripts/import_images.sh ./docker_images/images_*.tar.gz

# 3. 启动服务
docker compose -f docker-compose.offline.yaml up -d
```

**注意**: 如果 FastAPI 镜像名称不同，请先修改 `docker-compose.offline.yaml` 中的 `image` 字段，或使用以下命令打标签:

```bash
docker tag <实际镜像名> pyt-fastapi:latest
```

## 常见问题

**Q: 如何查看实际的 FastAPI 镜像名称?**
```bash
docker images | grep fastapi
```

**Q: 镜像文件太大怎么办?**
- 脚本已自动压缩
- 可以分别导出每个镜像（修改脚本）

**Q: PowerShell 脚本无法运行?**
- 检查执行策略: `Get-ExecutionPolicy`
- 临时允许: `Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass`
