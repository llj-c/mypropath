# Redis 配置文件

# 网络配置
# 生产环境建议: 如果只允许本地访问, 改为 127.0.0.1; 如果允许特定IP, 使用防火墙规则
bind 127.0.0.1
port 6379
# 生产环境必须: 保持为 yes, 并设置密码
protected-mode yes
tcp-backlog 511
timeout 0
tcp-keepalive 300

# 通用配置
daemonize no
# 生产环境建议: 如果使用 systemd 管理, 设置为 systemd
supervised no
pidfile /var/run/redis_6379.pid
# 生产环境建议: 根据需求调整日志级别 (debug/verbose/notice/warning)
loglevel notice
# 生产环境必须: 设置日志文件路径, 不要使用空字符串
logfile ""
# 生产环境建议: 如果不需要多个数据库, 可以减少到 1-2 个以提高性能
databases 16

# 快照配置 (RDB 持久化)
# 生产环境建议: 根据数据重要性调整保存策略
# save 900 1      # 900秒内至少1个key变化
# save 300 10     # 300秒内至少10个key变化
# save 60 10000   # 60秒内至少10000个key变化
# 如果数据非常重要, 可以增加保存频率; 如果可接受数据丢失, 可以减少频率
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /data

# 主从复制配置
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5
# repl-disable-tcp-nodelay no
# replica-priority 100

# 安全配置
# 生产环境必须: 取消注释并设置强密码
# requirepass youpassword
# 生产环境建议: 禁用危险命令以提高安全性
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command KEYS ""
# rename-command CONFIG ""

# 内存管理
# 生产环境必须调整: 根据服务器内存和实际需求设置, 建议预留 20-30% 给系统
# 例如: 8GB 服务器可以设置为 5-6GB
maxmemory 2gb
# 生产环境建议: 根据业务场景选择策略
# allkeys-lru: 所有key中最近最少使用的 (通用场景)
# volatile-lru: 设置了过期时间的key中最近最少使用的
# allkeys-random: 随机删除
# volatile-ttl: 删除即将过期的key
maxmemory-policy allkeys-lru
maxmemory-samples 5

# AOF 持久化配置
# 生产环境建议: 如果数据非常重要, 保持 yes; 如果性能优先, 可以设为 no (仅使用RDB)
appendonly yes
appendfilename "appendonly.aof"
# 生产环境建议: 根据数据重要性选择
# always: 每个写命令都同步 (最安全, 性能最低)
# everysec: 每秒同步一次 (平衡, 推荐)
# no: 由操作系统决定 (最快, 但可能丢失数据)
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Lua 脚本配置
lua-time-limit 5000

# 慢日志配置
# 生产环境建议: 根据性能要求调整, 10000 微秒 = 10 毫秒
# 如果对性能要求高, 可以降低到 5000 (5ms)
slowlog-log-slower-than 10000
# 生产环境建议: 增加慢日志记录数量, 便于排查问题
slowlog-max-len 128

# 延迟监控
# 生产环境建议: 启用延迟监控, 设置为 100 (100毫秒) 或根据需求调整
latency-monitor-threshold 0

# 事件通知
notify-keyspace-events ""

# 高级配置
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000
stream-node-max-bytes 4096
stream-node-max-entries 100
activerehashing yes
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60
hz 10
dynamic-hz yes
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes
